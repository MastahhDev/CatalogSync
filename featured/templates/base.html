{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>ProshopGames</title>
    {% load static %}
    <link rel="icon" type="image/png" sizes="64x32" href="{% static 'img/proshop_logo.png' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}?v={{ now|date:'U' }}">
    {% block extra_css %}{% endblock %}
</head>

<body>
  <!-- Token CSRF oculto para HTMX -->
  <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

  <!--  NAVBAR FIJO -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
      <div class="container">
          <a class="navbar-brand" href="/">
              <img src="{% static 'img/proshop_logo.png' %}" alt="Logo" width="64" height="40" class="me-2 loguito">
          </a>
          <button 
               class="navbar-toggler" 
               type="button" 
               data-bs-toggle="collapse" 
               data-bs-target="#navbarNav" 
               aria-controls="navbarNav" 
               aria-expanded="false" 
               aria-label="Toggle navigation">
               <span class="navbar-toggler-icon"></span>
           </button>

          <div class="collapse navbar-collapse" id="navbarNav">
              <ul class="navbar-nav ms-auto">
                  <li class="nav-item">
                      <a class="nav-link active" href="/catalogo/">Completo</a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link active" href="{% url 'catalogo:ps4' %}">PS4</a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link active" href="{% url 'catalogo:ps5' %}">PS5</a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link active" href="/questions/">Preguntas</a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link active" href="/about/">Sobre nosotros</a>
                  </li>
              </ul>
          </div>

          <div class="ml-auto">
              <button id="theme-toggle" class="btn btn-light">
                  <span id="theme-icon"></span>
                  <span id="theme-text"></span>
              </button>
          </div>

          <div class="ms-3">
              <button id="carrito-toggle" 
                      class="btn btn-light position-relative carro"
                      hx-get="{% url 'carrito:ver' %}"
                      hx-target="#carrito-popup-inner"
                      hx-swap="innerHTML"
                      onclick="abrirCarrito()">
                  <i class="fas fa-shopping-cart"></i>
                  <span id="carrito-badge" class="badge bg-danger rounded-pill position-absolute top-0 start-100 translate-middle carro" style="display: none;">
                      0
                  </span>
              </button>
          </div>
      </div>    
  </nav>

  <!--  CONTENIDO ANIMADO -->
  <div id="page-wrapper" class="page-transition">
      {% block content %}
      {% endblock %}
  </div>

  <!--  OVERLAY Y POPUP DEL CARRITO -->
  <div id="carrito-overlay" class="carrito-overlay" onclick="cerrarCarrito()"></div>
  <div id="carrito-popup" class="carrito-popup">
      <div id="carrito-popup-inner"></div>
  </div>

  <!--  CONTENEDOR DE NOTIFICACIONES -->
  <div id="carrito-notification"></div>

  <!--  FOOTER -->
  <footer class="footer">
      <div class="container">
          <p>&copy; 2025 CatalogSync. Todos los derechos reservados.</p>
      </div>
  </footer>

  <!--  SCRIPTS -->

  <!-- Facebook Pixel -->
  {% if FACEBOOK_PIXEL_ID %}
  <script>
  !function(f,b,e,v,n,t,s)
  {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};
  if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
  n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}(window, document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');
  fbq('init', '{{ FACEBOOK_PIXEL_ID }}');
  fbq('track', 'PageView');
  </script>
  <noscript>
      <img height="1" width="1" style="display:none"
      src="https://www.facebook.com/tr?id={{ FACEBOOK_PIXEL_ID }}&ev=PageView&noscript=1"/>
  </noscript>
  {% endif %}

  <!-- Script de Animaciones de P谩gina -->
  <script>
  (function() {
    function inicializarAnimacion() {
      const page = document.getElementById("page-wrapper");
      if (!page) return;
      
      page.classList.remove("active");
      page.classList.add("page-transition");
      
      setTimeout(() => {
        page.classList.add("active");
      }, 10);
    }

    // Al cargar la p谩gina normalmente
    document.addEventListener("DOMContentLoaded", inicializarAnimacion);
    
    // Al volver con el bot贸n atr谩s (fix para bfcache)
    window.addEventListener('pageshow', function(event) {
      if (event.persisted) {
        inicializarAnimacion();
      }
    });

    // Transiciones al hacer clic en links
    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll('a').forEach(link => {
        if (link.hostname === window.location.hostname) {
          link.addEventListener('click', e => {
            const target = e.currentTarget.getAttribute('href');
            if (target && target[0] !== '#') {
              e.preventDefault();
              const page = document.getElementById("page-wrapper");
              if (page) page.classList.remove("active");
              setTimeout(() => { window.location.href = target; }, 300);
            }
          });
        }
      });
    });
  })();
  </script>

  <!-- Script de Navbar con Sombra -->
  <script>
    document.addEventListener("scroll", function() {
      const navbar = document.querySelector(".navbar");
      if (window.scrollY > 10) {
        navbar.classList.add("navbar-shadow");
      } else {
        navbar.classList.remove("navbar-shadow");
      }
    });
  </script>

  <!-- Script de Bot贸n Volver Arriba -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const topBtn = document.getElementById('back-to-top');
      if (!topBtn) return;

      window.addEventListener('scroll', () => {
        const scrollTop = window.scrollY;
        const trigger = 50;
        const fadeDistance = 300;

        if (scrollTop > trigger) {
          let opacity = (scrollTop - trigger) / fadeDistance;
          if (opacity > 1) opacity = 1;
          topBtn.classList.add('visible');
          topBtn.style.opacity = opacity;
        } else {
          topBtn.classList.remove('visible');
          topBtn.style.opacity = 0;
        }
      });

      topBtn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    });
  </script>

  <!-- Script del Carrito -->
  <script>
  (function() {
    const carritoPopup = document.getElementById('carrito-popup');
    const carritoOverlay = document.getElementById('carrito-overlay');

    // Funci贸n global para abrir el carrito
    window.abrirCarrito = function() {
      const isMobile = window.matchMedia("(max-width: 768px)").matches;
      carritoPopup.style.animation = isMobile
        ? "carritoSlideInMobile 0.45s cubic-bezier(0.22, 1, 0.36, 1) forwards"
        : "carritoSlideInDesktop 0.45s cubic-bezier(0.22, 1, 0.36, 1) forwards";

      carritoOverlay.classList.add('show');
      carritoPopup.classList.add('show');
    };

    // Funci贸n global para cerrar el carrito
    window.cerrarCarrito = function() {
      const isMobile = window.matchMedia("(max-width: 768px)").matches;
      carritoPopup.style.animation = isMobile
        ? "carritoSlideOutMobile 0.45s ease forwards"
        : "carritoSlideOutDesktop 0.45s ease forwards";

      carritoPopup.addEventListener('animationend', function handler() {
        if (carritoPopup.style.animation.includes("Out")) {
          carritoPopup.classList.remove('show');
          carritoOverlay.classList.remove('show');
        }
        carritoPopup.removeEventListener('animationend', handler);
      });
    };

  })();
  </script>

  <!-- Script CSRF para HTMX -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        const csrftoken = getCookie('csrftoken');
        
        document.body.addEventListener('htmx:configRequest', function(event) {
            if (event.detail.verb === 'post') {
                event.detail.headers['X-CSRFToken'] = csrftoken;
            }
        });
        
        document.body.addEventListener('htmx:beforeRequest', function(event) {
            if (event.detail.verb === 'POST' && csrftoken) {
                const xhr = event.detail.xhr;
                xhr.setRequestHeader('X-CSRFToken', csrftoken);
            }
        });
    });
  </script>

  <!-- Script de Tema -->
  <script src="{% static 'js/theme.js' %}?v={{ now|date:'U' }}"></script>

  <!-- Script de WhatsApp HTMX -->
  <script>
  document.body.addEventListener('htmx:afterOnLoad', (event) => {
      try {
          const data = JSON.parse(event.detail.xhr.responseText);
          if (data.url) {
              window.open(data.url, '_blank');
          } else if (data.error) {
              alert(data.error);
          }
      } catch (e) {
          // Si no es JSON, no hacemos nada
      }
  });
  </script>

  {% block extra_js %}{% endblock %}

</body>
</html>