{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <title>ProshopGames</title>
    {% load static %}
    <link rel="icon" type="image/png" sizes="64x32" href="{% static 'img/proshop_logo.png' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}?v={{ now|date:'U' }}">
    {% block extra_css %}{% endblock %}
</head>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const page = document.body;
    page.classList.add("page-transition");

    // Activa la animaci贸n al cargar
    setTimeout(() => {
      page.classList.add("active");
    }, 10);

    // Agrega animaci贸n al cambiar de p谩gina
    document.querySelectorAll('a').forEach(link => {
      if (link.hostname === window.location.hostname) {
        link.addEventListener('click', e => {
          const target = e.currentTarget.getAttribute('href');
          if (target && target[0] !== '#') {
            e.preventDefault();
            page.classList.remove("active");
            setTimeout(() => {
              window.location.href = target;
            }, 300);
          }
        });
      }
    });
  });

  
</script>

<body>
  <!-- Token CSRF oculto para HTMX -->
  <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

  <!--  NAVBAR FIJO -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
      <div class="container">
          <a class="navbar-brand" href="/">
              <img src="{% static 'img/proshop_logo.png' %}" alt="Logo" width="64" height="40" class="me-2 loguito">
          </a>
          <button 
               class="navbar-toggler" 
               type="button" 
               data-bs-toggle="collapse" 
               data-bs-target="#navbarNav" 
               aria-controls="navbarNav" 
               aria-expanded="false" 
               aria-label="Toggle navigation">
               <span class="navbar-toggler-icon"></span>
           </button>

          <div class="collapse navbar-collapse" id="navbarNav">
              <ul class="navbar-nav ms-auto">
                  <li class="nav-item">
                      <a class="nav-link active" href="/catalogo/">Completo</a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link active" href="{% url 'catalogo:ps4' %}">PS4</a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link active" href="{% url 'catalogo:ps5' %}">PS5</a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link active" href="/questions/">Preguntas</a>
                  </li>
                  <li class="nav-item">
                      <a class="nav-link active" href="/about/">Sobre nosotros</a>
                  </li>
              </ul>
          </div>

          <div class="ml-auto">
              <button id="theme-toggle" class="btn btn-light mode">
                  <span id="theme-icon"></span>
                  <span id="theme-text"></span>
              </button>
          </div>

          <div class="ms-3">
              <button id="carrito-toggle" 
                      class="btn btn-light position-relative carro"
                      hx-get="{% url 'carrito:ver' %}"
                      hx-target="#carrito-popup-inner"
                      hx-swap="innerHTML"
                      onclick="abrirCarrito()">
                  <i class="fas fa-shopping-cart"></i>
                  <span id="carrito-badge" class="badge bg-danger rounded-pill position-absolute top-0 start-100 translate-middle carro" style="display: none;">
                      0
                  </span>
              </button>
          </div>
      </div>    
  </nav>

  <!--  CONTENIDO ANIMADO -->
  <div id="page-wrapper" class="page-transition">
      {% block content %}
      {% endblock %}
  </div>

  <!--  OVERLAY Y POPUP DEL CARRITO -->
  <div id="carrito-overlay" class="carrito-overlay" onclick="cerrarCarrito()"></div>
  <div id="carrito-popup" class="carrito-popup">
      <div id="carrito-popup-inner"></div>
  </div>

  <!--  CONTENEDOR DE NOTIFICACIONES -->
  <div id="carrito-notification"></div>

  <!--  FOOTER -->
  <footer class="footer">
      <div class="container">
          <p>&copy; 2025 CatalogSync. Todos los derechos reservados.</p>
      </div>
  </footer>

  <!--  SCRIPTS -->
  <script>
    // Animaci贸n de transici贸n (ahora solo afecta al contenido)
    document.addEventListener("DOMContentLoaded", () => {
      const page = document.getElementById("page-wrapper");
      page.classList.add("page-transition");

      setTimeout(() => {
        page.classList.add("active");
      }, 10);

      document.querySelectorAll('a').forEach(link => {
        if (link.hostname === window.location.hostname) {
          link.addEventListener('click', e => {
            const target = e.currentTarget.getAttribute('href');
            if (target && target[0] !== '#') {
              e.preventDefault();
              page.classList.remove("active");
              setTimeout(() => { window.location.href = target; }, 300);
            }
          });
        }
      });
    });
  </script>

  <script>
    // Navbar con sombra al scrollear
    document.addEventListener("scroll", function() {
      const navbar = document.querySelector(".navbar");
      if (window.scrollY > 10) {
        navbar.classList.add("navbar-shadow");
      } else {
        navbar.classList.remove("navbar-shadow");
      }
    });
  </script>

  <script>
    // Bot贸n "Volver arriba"
    document.addEventListener("DOMContentLoaded", () => {
      const topBtn = document.getElementById('back-to-top');

      window.addEventListener('scroll', () => {
        const scrollTop = window.scrollY;
        const trigger = 50;
        const fadeDistance = 300;

        if (scrollTop > trigger) {
          let opacity = (scrollTop - trigger) / fadeDistance;
          if (opacity > 1) opacity = 1;
          topBtn.classList.add('visible');
          topBtn.style.opacity = opacity;
        } else {
          topBtn.classList.remove('visible');
          topBtn.style.opacity = 0;
        }
      });

      topBtn.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    });
  </script>

  <script>
    // Carrito (abrir / cerrar)
     const carritoPopup = document.getElementById('carrito-popup');
  const carritoOverlay = document.getElementById('carrito-overlay');

  function abrirCarrito() {
    const isMobile = window.matchMedia("(max-width: 768px)").matches;
    carritoPopup.style.animation = isMobile
      ? "carritoSlideInMobile 0.45s cubic-bezier(0.22, 1, 0.36, 1) forwards"
      : "carritoSlideInDesktop 0.45s cubic-bezier(0.22, 1, 0.36, 1) forwards";

    carritoOverlay.classList.add('show');

    // Asegura que aparezca si estaba oculto
    carritoPopup.classList.add('show');
  }

  function cerrarCarrito() {
    const isMobile = window.matchMedia("(max-width: 768px)").matches;
    carritoPopup.style.animation = isMobile
      ? "carritoSlideOutMobile 0.45s ease forwards"
      : "carritoSlideOutDesktop 0.45s ease forwards";

    // Espera a que termine la animaci贸n antes de ocultarlo
    carritoPopup.addEventListener('animationend', () => {
      if (carritoPopup.style.animation.includes("Out")) {
        carritoPopup.classList.remove('show');
        carritoOverlay.classList.remove('show');
      }
    }, { once: true });
  }

    // CSRF para HTMX
    document.addEventListener('DOMContentLoaded', function() {
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        const csrftoken = getCookie('csrftoken');
        
        document.body.addEventListener('htmx:configRequest', function(event) {
            if (event.detail.verb === 'post') {
                event.detail.headers['X-CSRFToken'] = csrftoken;
            }
        });
        
        document.body.addEventListener('htmx:beforeRequest', function(event) {
            if (event.detail.verb === 'POST' && csrftoken) {
                const xhr = event.detail.xhr;
                xhr.setRequestHeader('X-CSRFToken', csrftoken);
            }
        });
    });
  </script>

  <script src="{% static 'js/theme.js' %}?v={{ now|date:'U' }}"></script>

  <script>
  document.body.addEventListener('htmx:afterOnLoad', (event) => {
      try {
          const data = JSON.parse(event.detail.xhr.responseText);
          if (data.url) {
              window.open(data.url, '_blank'); // abre WhatsApp con el mensaje
          } else if (data.error) {
              alert(data.error);
          }
      } catch (e) {
          // Si no es JSON, no hacemos nada
      }
  });
  </script>

  {% block extra_js %}{% endblock %}

  <script>
window.addEventListener('scroll', () => {
  document.documentElement.style.setProperty('--scroll-y', `${window.scrollY}px`);
});

function abrirCarrito() {
  const carritoPopup = document.getElementById('carrito-popup');
  const carritoOverlay = document.getElementById('carrito-overlay');

  carritoPopup.classList.add('show');
  carritoOverlay.classList.add('show');
}
</script>




</body>
</html>
