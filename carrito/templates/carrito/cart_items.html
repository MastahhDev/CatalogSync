<!-- carrito/templates/carrito/cart_items.html -->
{% load static %}

<!-- Contenedor con scroll condicional -->
<div class="cart-items-container {% if items|length > 3 %}with-scroll{% endif %}">
    {% for item in items %}
    <div class="cart-item" data-item-key="{{ item.item_key }}">
        <div class="cart-item-image">
            <img src="{% static item.juego.imagen %}" 
                 alt="{{ item.juego.nombre }}"
                 onerror="this.src='/static/img/default.png'">
        </div>
        
        <div class="cart-item-details">
            <h6 class="cart-item-name text-dark-emphasis">{{ item.juego.nombre }}</h6>
            
            <!-- Badge de tipo de precio -->
            {% if item.tipo_precio == 'secundario' %}
                <span class="badge bg-info">ðŸ”µ Secundario</span>
            {% else %}
                <span class="badge bg-success">ðŸŸ¢ Primario</span>
            {% endif %}
            
            <div class="cart-item-price">
                <!-- Precio principal (el que se cobra) -->
                {% if item.precio and item.precio > 0 %}
                    <span class="price-main fw-bold text-success">
                        ${{ item.precio|floatformat:0 }}
                    </span>
                {% else %}
                    <span class="price-main fw-bold text-danger">
                        Precio no disponible
                    </span>
                {% endif %}
                
                <!-- Precio con recargo (tachado, solo si existe) -->
                {% if item.precio_recargo and item.precio_recargo > 0 %}
                    <span class="price-recargo text-muted text-decoration-line-through">
                        ${{ item.precio_recargo|floatformat:0 }}
                    </span>
                {% endif %}
            </div>
            
            <div class="cart-item-quantity">
                <button class="btn btn-sm btn-outline-secondary"
                        hx-post="{% url 'carrito:actualizar' item.item_key %}"
                        hx-vals='{"cantidad": {{ item.cantidad|add:"-1" }}}'
                        hx-target="#carrito-items-container"
                        hx-swap="innerHTML">
                    <i class="fas fa-minus"></i>
                </button>
                
                <span class="quantity-display text-body">{{ item.cantidad }}</span>
                
                <button class="btn btn-sm btn-outline-secondary"
                        hx-post="{% url 'carrito:actualizar' item.item_key %}"
                        hx-vals='{"cantidad": {{ item.cantidad|add:"1" }}}'
                        hx-target="#carrito-items-container"
                        hx-swap="innerHTML">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            
            <div class="cart-item-subtotal text-body-secondary">
                Subtotal: <strong class="text-body">${{ item.subtotal|floatformat:0 }}</strong>
            </div>
        </div>
        
        <button class="btn btn-sm btn-danger cart-item-remove"
                hx-post="{% url 'carrito:eliminar' item.item_key %}"
                hx-target="#carrito-items-container"
                hx-swap="innerHTML"
                title="Eliminar">
            <i class="fas fa-trash"></i>
        </button>
    </div>
    {% endfor %}
</div>

<div class="cart-total bg-body-tertiary border-top">
    <div class="d-flex justify-content-between align-items-center">
        <h5 class="text-body">Total:</h5>
        <h4 class="text-primary fw-bold">${{ total_price|floatformat:0 }}</h4>
    </div>
    
    <button class="btn btn-success w-100 mt-3"
            hx-post="{% url 'carrito:finalizar' %}"
            hx-vals='{"metodo_pago": "transferencia"}'
            hx-on::after-request="if(event.detail.xhr.response) { const data = JSON.parse(event.detail.xhr.response); window.open(data.url, '_blank'); }">
        <i class="fab fa-whatsapp"></i> Finalizar por WhatsApp
    </button>
    
    <button class="btn btn-outline-danger w-100 mt-2"
            hx-post="{% url 'carrito:vaciar' %}"
            hx-target="#carrito-items-container"
            hx-swap="innerHTML"
            hx-confirm="Â¿EstÃ¡s seguro de vaciar el carrito?">
        <i class="fas fa-trash"></i> Vaciar carrito
    </button>
</div>

<!-- â­ ACTUALIZAR BADGE DEL CARRITO -->
<span id="carrito-badge" class="badge bg-danger rounded-pill" hx-swap-oob="true">
    {{ total_items }}
</span>

<style>
.cart-items-container {
    /* Contenedor base sin scroll */
    max-height: none;
    overflow-y: visible;
}

.cart-items-container.with-scroll {
    /* Contenedor con scroll cuando hay mÃ¡s de 3 items */
    max-height: 400px; /* Altura mÃ¡xima ajustable */
    overflow-y: auto;
    border: 1px solid var(--bs-border-color);
    border-radius: 8px;
    margin-bottom: 15px;
    background: var(--bs-body-bg);
}

.cart-item {
    display: flex;
    gap: 15px;
    padding: 15px;
    border-bottom: 1px solid var(--bs-border-color);
    position: relative;
    align-items: center;
    background: var(--bs-body-bg);
}

.cart-item:last-child {
    border-bottom: none;
}

.cart-item-image img {
    width: 60px;
    height: 80px;
    object-fit: cover;
    border-radius: 4px;
}

.cart-item-details {
    flex: 1;
}

.cart-item-name {
    font-size: 0.9rem;
    margin-bottom: 5px;
    font-weight: 600;
}

.cart-item-price {
    display: flex;
    gap: 8px;
    align-items: center;
    margin: 5px 0;
}

.price-main {
    font-size: 1.1rem;
}

.price-recargo {
    font-size: 0.85rem;
}

.cart-item-quantity {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 10px 0;
}

.quantity-display {
    min-width: 30px;
    text-align: center;
    font-weight: bold;
}

.cart-item-subtotal {
    font-size: 0.9rem;
}

.cart-item-remove {
    position: absolute;
    top: 10px;
    right: 10px;
}

.cart-total {
    padding: 20px;
    border-top: 2px solid var(--bs-border-color);
    position: sticky;
    bottom: 0;
    /* Asegurar que estÃ© por encima del contenido */
    z-index: 10;
}

.badge {
    font-size: 0.7rem;
    padding: 3px 8px;
    margin: 5px 0;
}

/* Personalizar scrollbar para tema oscuro */
.cart-items-container.with-scroll::-webkit-scrollbar {
    width: 6px;
}

.cart-items-container.with-scroll::-webkit-scrollbar-track {
    background: var(--bs-secondary-bg);
    border-radius: 3px;
}

.cart-items-container.with-scroll::-webkit-scrollbar-thumb {
    background: var(--bs-border-color);
    border-radius: 3px;
}

.cart-items-container.with-scroll::-webkit-scrollbar-thumb:hover {
    background: var(--bs-tertiary-color);
}

/* Para Firefox */
.cart-items-container.with-scroll {
    scrollbar-width: thin;
    scrollbar-color: var(--bs-border-color) var(--bs-secondary-bg);
}

/* Asegurar que los textos sean legibles en ambos temas */
@media (prefers-color-scheme: dark) {
    .cart-items-container.with-scroll {
        background: var(--bs-body-bg);
    }
    
    .cart-item {
        background: var(--bs-body-bg);
    }
}

</style>

