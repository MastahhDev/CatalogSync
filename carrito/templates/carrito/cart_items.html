<!-- carrito/templates/carrito/cart_items.html -->
{% load static %}

{% for item in items %}
<div class="cart-item" data-item-key="{{ item.item_key }}">
    <div class="cart-item-image">
        <img src="{% static item.juego.imagen %}" 
             alt="{{ item.juego.nombre }}"
             onerror="this.src='/static/img/default.png'">
    </div>
    
    <div class="cart-item-details">
        <h6 class="cart-item-name">{{ item.juego.nombre }}</h6>
        
        <!-- â­ NUEVO: Badge de tipo de precio -->
        {% if item.tipo_precio == 'secundario' %}
            <span class="badge bg-info">ðŸ”µ Secundario</span>
        {% else %}
            <span class="badge bg-success">ðŸŸ¢ Primario</span>
        {% endif %}
        
        <div class="cart-item-price">
            <span class="price-base text-muted text-decoration-line-through">
                ${{ item.precio_base|floatformat:0 }}
            </span>
            <span class="price-final fw-bold">
                ${{ item.precio_final|floatformat:0 }}
            </span>
        </div>
        
        <div class="cart-item-quantity">
            <button class="btn btn-sm btn-outline-secondary"
                    hx-post="{% url 'carrito:actualizar' item.item_key %}"
                    hx-vals='{"cantidad": {{ item.cantidad|add:"-1" }}}'
                    hx-target=".cart-content"
                    hx-swap="innerHTML">
                <i class="fas fa-minus"></i>
            </button>
            
            <span class="quantity-display">{{ item.cantidad }}</span>
            
            <button class="btn btn-sm btn-outline-secondary"
                    hx-post="{% url 'carrito:actualizar' item.item_key %}"
                    hx-vals='{"cantidad": {{ item.cantidad|add:"1" }}}'
                    hx-target=".cart-content"
                    hx-swap="innerHTML">
                <i class="fas fa-plus"></i>
            </button>
        </div>
        
        <div class="cart-item-subtotal">
            Subtotal: <strong>${{ item.subtotal|floatformat:0 }}</strong>
        </div>
    </div>
    
    <button class="btn btn-sm btn-danger cart-item-remove"
            hx-post="{% url 'carrito:eliminar' item.item_key %}"
            hx-target=".cart-content"
            hx-swap="innerHTML"
            title="Eliminar">
        <i class="fas fa-trash"></i>
    </button>
</div>
{% endfor %}

<div class="cart-total">
    <div class="d-flex justify-content-between align-items-center">
        <h5>Total:</h5>
        <h4 class="text-primary">${{ total_price|floatformat:0 }}</h4>
    </div>
    
    <button class="btn btn-success w-100 mt-3"
            hx-post="{% url 'carrito:finalizar' %}"
            hx-vals='{"metodo_pago": "transferencia"}'
            hx-on::after-request="if(event.detail.xhr.response) { const data = JSON.parse(event.detail.xhr.response); window.open(data.url, '_blank'); }">
        <i class="fab fa-whatsapp"></i> Finalizar por WhatsApp
    </button>
    
    <button class="btn btn-outline-danger w-100 mt-2"
            hx-post="{% url 'carrito:vaciar' %}"
            hx-target=".cart-content"
            hx-swap="innerHTML"
            hx-confirm="Â¿EstÃ¡s seguro de vaciar el carrito?">
        <i class="fas fa-trash"></i> Vaciar carrito
    </button>
</div>

<style>
.cart-item {
    display: flex;
    gap: 15px;
    padding: 15px;
    border-bottom: 1px solid #e0e0e0;
    position: relative;
    align-items: center;
}

.cart-item-image img {
    width: 60px;
    height: 80px;
    object-fit: cover;
    border-radius: 4px;
}

.cart-item-details {
    flex: 1;
}

.cart-item-name {
    font-size: 0.9rem;
    margin-bottom: 5px;
    font-weight: 600;
}

.cart-item-price {
    display: flex;
    gap: 8px;
    align-items: center;
    margin: 5px 0;
}

.price-base {
    font-size: 0.85rem;
}

.price-final {
    font-size: 1.1rem;
    color: #2c3e50;
}

.cart-item-quantity {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 10px 0;
}

.quantity-display {
    min-width: 30px;
    text-align: center;
    font-weight: bold;
}

.cart-item-subtotal {
    font-size: 0.9rem;
    color: #555;
}

.cart-item-remove {
    position: absolute;
    top: 10px;
    right: 10px;
}

.cart-total {
    padding: 20px;
    border-top: 2px solid #e0e0e0;
    background: #f8f9fa;
}

/* Badge de tipo de precio */
.badge {
    font-size: 0.7rem;
    padding: 3px 8px;
    margin: 5px 0;
}
</style>

<script>
// Formatear precios con separadores de miles
document.querySelectorAll('.price-final, .cart-item-subtotal strong, .cart-total h4').forEach(el => {
    let text = el.textContent.trim();
    if (text.includes('$')) {
        let price = text.replace(/[^\d]/g, '');
        el.textContent = '$' + parseInt(price).toLocaleString('es-AR');
    }
});
</script>

